version: '3.8'

services:
  # Nginx reverse proxy with HTTPS
  nginx:
    image: nginx:alpine
    container_name: shelia-nginx-proxy
    ports:
      - "80:80"    # HTTP (redirects to HTTPS)
      - "443:443"  # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - face-recognition
    restart: unless-stopped
    networks:
      - face-recognition-network

  face-recognition:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shelia-face-recognition
    expose:
      - "8000"  # Only expose internally, not to host
    environment:
      # API Settings
      - APP_NAME=Shelia Face Recognition Service
      - DEBUG=false
      - LOG_LEVEL=info

      # Security Settings
      # IMPORTANT: Change this token in production!
      # Generate with: openssl rand -hex 32
      - API_TOKEN=${API_TOKEN:-your-secure-random-token-here-change-this-in-production}

      # Model Settings
      - MODEL_NAME=buffalo_l
      - DETECTION_THRESHOLD=0.5
      - DEVICE=cpu

      # Image Processing
      - MAX_IMAGE_SIZE=10485760

      # CORS Settings
      - CORS_ENABLED=true
      # For production, specify exact origins:
      # - CORS_ORIGINS=["https://your-backend.com"]
    volumes:
      # Optional: Mount .insightface directory to cache models
      # This prevents re-downloading models on container restart
      - insightface-models:/app/.insightface
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    networks:
      - face-recognition-network

networks:
  face-recognition-network:
    driver: bridge

volumes:
  insightface-models:
    driver: local
